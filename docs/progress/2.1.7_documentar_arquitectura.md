# 2.1.7 - Documentar Arquitectura en ARCHITECTURE.md

**Estado:** âœ… Completada  
**Fecha:** 2025-11-13  
**Rama:** feature/documentar-arquitectura  
**Autor:** JuanPMorales

---

## ğŸ“‹ Resumen

Se completÃ³ la documentaciÃ³n exhaustiva de la arquitectura del proyecto Task Timer en el archivo `docs/ARCHITECTURE.md`. El documento incluye diagramas C4, flujos de datos, componentes principales, patrones de diseÃ±o, y estrategias de testing siguiendo Clean Architecture y principios SOLID.

**Logros principales:**
- âœ… DocumentaciÃ³n completa de Clean Architecture (1,919 lÃ­neas)
- âœ… Diagramas Mermaid para visualizaciÃ³n de capas y flujos
- âœ… Especificaciones detalladas de cada componente
- âœ… Decisiones de arquitectura (ADRs) documentadas
- âœ… Estrategias de testing y CI/CD definidas

---

## âœ… Tareas Completadas

- [x] Documentar estructura de capas (Domain, Data, Presentation)
- [x] Crear diagramas C4 (Context, Container, Component)
- [x] Documentar flujo de datos con Riverpod
- [x] Especificar patrones de diseÃ±o utilizados
- [x] Documentar modelo de datos (SQLite)
- [x] Incluir decisiones de arquitectura (ADRs)
- [x] Documentar estrategia de testing
- [x] Definir integraciÃ³n con servicios nativos
- [x] Documentar gestiÃ³n de estado con Riverpod
- [x] Incluir ejemplos de cÃ³digo por capa

---

## ğŸ“ Archivos Documentados

### ARCHITECTURE.md (1,919 lÃ­neas)

**Secciones completadas:**

1. **Resumen Ejecutivo**
   - Principios guÃ­a: Offline-first, Privacy by design, SOLID
   - Objetivos: Fiabilidad, Persistencia, Testabilidad

2. **VisiÃ³n de Alto Nivel**
   - Diagrama de arquitectura en capas
   - Flujo de datos bidireccional

3. **Diagramas C4**
   - Context Diagram (Nivel 1): Usuario, App, OS, SQLite
   - Container Diagram (Nivel 2): Capas UI, Presentation, Domain, Data
   - Component Diagram (Nivel 3): Providers, UseC ases, Repositories
   - Sequence Diagram: Flujo de inicio de timer

4. **Componentes Principales**
   - **Presentation Layer:**
     - TaskListScreen, TimerScreen
     - TaskProvider, TimerProvider (StateNotifier)
   - **Domain Layer:**
     - Entities: Task, TimerSession
     - UseCases: CreateTask, StartTimer, RestoreTimer
     - Repositories (interfaces)
   - **Data Layer:**
     - Models: TaskModel, TimerSessionModel
     - Repositories (implementaciones)
     - DatabaseHelper

5. **Modelo de Datos**
   - Esquema SQLite:
     - Tabla `tasks`: id, name, duration_seconds, color, created_at, updated_at, is_archived
     - Tabla `timer_sessions`: id, task_id, start_timestamp, end_timestamp, elapsed_seconds, status
   - Ãndices de performance

6. **Patrones de DiseÃ±o**
   - Repository Pattern
   - Use Case Pattern
   - Provider Pattern (Riverpod)
   - Singleton Pattern (DatabaseHelper)
   - Factory Pattern (Models)

7. **GestiÃ³n de Estado**
   - Riverpod con StateNotifier
   - Estado inmutable
   - SeparaciÃ³n de lÃ³gica UI vs negocio

8. **Flujo del Timer**
   - Basado en timestamps (no Timer.periodic)
   - RestauraciÃ³n desde SQLite
   - Continuidad en background

9. **Dependency Injection**
   - Providers como DI container
   - InyecciÃ³n en constructores
   - Testabilidad con mocks

10. **Decisiones de Arquitectura (ADRs)**
    - ADR-001: Clean Architecture
    - ADR-002: Riverpod para estado
    - ADR-003: SQLite local (no backend)
    - ADR-004: Timer basado en timestamps
    - ADR-005: Dark mode por defecto

11. **IntegraciÃ³n con Plataforma**
    - VolumeButtonService (MethodChannel)
    - BackgroundService (Foreground Service Android)
    - VibrationService (feedback hÃ¡ptico)

12. **Estrategia de Performance**
    - CachÃ© en memoria para tareas
    - Lazy loading de queries
    - Ãndices de base de datos
    - Throttling de UI updates

13. **Seguridad**
    - Datos 100% locales
    - Sin analytics ni tracking
    - SQLite sin encriptaciÃ³n (MVP)

14. **Observabilidad y Logging**
    - Logger personalizado (lib/core/utils/logger.dart)
    - Niveles: debug, info, warning, error, critical

15. **Migraciones de Base de Datos**
    - Sistema versionado (DatabaseHelper)
    - MigraciÃ³n v1â†’v2 documentada

16. **Testing Strategy**
    - Unit tests: Domain y Data layers
    - Widget tests: Presentation layer
    - Integration tests: Flujos completos
    - Coverage objetivo: >70%

17. **CI/CD Pipeline**
    - GitHub Actions
    - Lint, test, coverage
    - Build Android/iOS

18. **Riesgos TÃ©cnicos**
    - Variabilidad de control de volumen por fabricante
    - Background execution en iOS limitado
    - Mitigaciones documentadas

19. **Mapeo a Sprints**
    - Sprint 1-2: CRUD de tareas
    - Sprint 3-4: Timer core
    - Sprint 5: Background service

20. **Entregables**
    - APK/IPA funcional
    - DocumentaciÃ³n completa
    - Tests automatizados

---

## ğŸ¨ Diagramas Implementados

### Diagrama de Arquitectura Clean

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UI Layer (Flutter)                        â”‚
â”‚  TaskListScreen | TimerScreen | Widgets | Themes            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Presentation Layer (Riverpod)                   â”‚
â”‚  TaskProvider | TimerProvider | ViewModels                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Domain Layer (Pure Dart)                   â”‚
â”‚  Entities: Task, TimerSession                                â”‚
â”‚  UseCases: CreateTask, StartTimer, RestoreTimer             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Data Layer                               â”‚
â”‚  Repositories: TaskRepository, TimerRepository              â”‚
â”‚  Models: TaskModel, TimerSessionModel                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Persistence (SQLite via sqflite)                â”‚
â”‚  DatabaseHelper | Schema | Migrations                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flujo de Datos con Riverpod

```
User Interaction (Tap "Create Task")
        â†“
TaskListScreen
        â†“
ref.read(taskProvider.notifier).createTask()
        â†“
TaskNotifier (StateNotifier)
        â†“
CreateTaskUseCase.execute()
        â†“
TaskRepository.create()
        â†“
DatabaseHelper.insert()
        â†“
SQLite Database
        â†“
TaskRepository returns Task
        â†“
Use Case returns success
        â†“
TaskNotifier.loadTasks() (refresh)
        â†“
ref.watch(taskProvider) triggers rebuild
        â†“
UI updates automatically
```

### Dependencias entre Capas

```
Presentation â”€â”€depends onâ”€â”€> Domain
Data â”€â”€depends onâ”€â”€> Domain
Domain â”€â”€depends onâ”€â”€> Nothing (Pure Dart)

Presentation CAN'T depend on Data
Domain CAN'T depend on Presentation or Data
```

---

## ğŸ”§ Estructura de Carpetas Documentada

```
lib/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ theme/
â”‚   â”‚   â”œâ”€â”€ app_colors.dart          # âœ… Implementado
â”‚   â”‚   â””â”€â”€ app_text_styles.dart     # âœ… Implementado
â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â””â”€â”€ app_constants.dart       # âœ… Implementado
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ time_formatter.dart      # âœ… Implementado
â”‚   â”‚   â”œâ”€â”€ validators.dart          # âœ… Implementado
â”‚   â”‚   â””â”€â”€ logger.dart              # â³ Pendiente (Sprint 2)
â”‚   â””â”€â”€ errors/
â”‚       â”œâ”€â”€ exceptions.dart          # âœ… Implementado
â”‚       â””â”€â”€ failures.dart            # âœ… Implementado
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ task_model.dart          # â³ Pendiente (Sprint 1)
â”‚   â”‚   â””â”€â”€ timer_session_model.dart # â³ Pendiente (Sprint 3)
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ *_repository_impl.dart   # â³ Pendiente
â”‚   â””â”€â”€ database/
â”‚       â”œâ”€â”€ database_helper.dart     # â³ Pendiente (Sprint 2)
â”‚       â””â”€â”€ migrations.dart          # â³ Pendiente
â”‚
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ task.dart                # â³ Pendiente (Sprint 1)
â”‚   â”‚   â””â”€â”€ timer_session.dart       # â³ Pendiente (Sprint 3)
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â””â”€â”€ *_repository.dart        # â³ Pendiente (interfaces)
â”‚   â””â”€â”€ usecases/
â”‚       â”œâ”€â”€ create_task.dart         # â³ Pendiente (Sprint 1)
â”‚       â”œâ”€â”€ start_timer.dart         # â³ Pendiente (Sprint 3)
â”‚       â””â”€â”€ restore_timer.dart       # â³ Pendiente (Sprint 5)
â”‚
â”œâ”€â”€ presentation/
â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”œâ”€â”€ task_provider.dart       # â³ Pendiente (Sprint 1)
â”‚   â”‚   â””â”€â”€ timer_provider.dart      # â³ Pendiente (Sprint 3)
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ task_list_screen.dart    # â³ Pendiente (Sprint 1)
â”‚   â”‚   â””â”€â”€ timer_screen.dart        # â³ Pendiente (Sprint 3)
â”‚   â””â”€â”€ widgets/
â”‚       â”œâ”€â”€ task_card.dart           # â³ Pendiente (Sprint 1)
â”‚       â””â”€â”€ circular_progress.dart   # â³ Pendiente (Sprint 3)
â”‚
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ volume_button_service.dart   # â³ Pendiente (Sprint 4)
â”‚   â”œâ”€â”€ vibration_service.dart       # â³ Pendiente (Sprint 4)
â”‚   â””â”€â”€ background_service.dart      # â³ Pendiente (Sprint 5)
â”‚
â””â”€â”€ main.dart                         # âœ… Implementado (base)
```

---

## ğŸ“ Decisiones TÃ©cnicas

### 1. Clean Architecture

**DecisiÃ³n:** Separar el cÃ³digo en capas Domain, Data y Presentation siguiendo Clean Architecture.

**Razones:**
- Testabilidad: LÃ³gica de negocio independiente de framework
- Mantenibilidad: Cambios en UI no afectan lÃ³gica
- Escalabilidad: FÃ¡cil agregar features sin romper cÃ³digo existente
- Reusabilidad: Domain layer puede usarse en otras plataformas

**Trade-offs:**
- âœ… Pros: CÃ³digo limpio, testeable, mantenible
- âŒ Cons: MÃ¡s archivos (boilerplate), curva de aprendizaje inicial

### 2. Riverpod para Estado

**DecisiÃ³n:** Usar Riverpod en lugar de Provider, Bloc o GetX.

**Razones:**
- Compile-time safety (no `of(context)` que pueda fallar)
- No depende de BuildContext
- Testing mÃ¡s simple (no necesita widgets)
- Menos boilerplate que Bloc
- Performance (rebuilds selectivos)

**Alternativas consideradas:**
- Provider: Menos type-safe
- Bloc: Demasiado boilerplate para MVP
- GetX: Problemas de mantenimiento, dependencias globales

### 3. Timer Basado en Timestamps

**DecisiÃ³n:** Usar `DateTime` con timestamps en lugar de `Timer.periodic`.

**Razones:**
- Robustez: Sobrevive a kills de proceso
- RestauraciÃ³n: FÃ¡cil calcular tiempo transcurrido desde SQLite
- Background: No depende de timer activo en memoria

**ImplementaciÃ³n:**
```dart
// Inicio
final startTime = DateTime.now();
await db.insert('timer_sessions', {
  'start_timestamp': startTime.toIso8601String(),
});

// CÃ¡lculo de elapsed
final now = DateTime.now();
final elapsed = now.difference(startTime).inSeconds;
final remaining = task.durationSeconds - elapsed;
```

### 4. SQLite Local (Sin Backend)

**DecisiÃ³n:** Persistencia 100% local con SQLite, sin API REST.

**Razones:**
- Privacy: Datos no salen del dispositivo
- Offline-first: Funciona sin conexiÃ³n
- Simplicidad: No mantener servidor
- Performance: Latencia <10ms

**MVP Scope:**
- âœ… Incluido: SQLite local
- âŒ Excluido: Sync en nube, multi-dispositivo

### 5. Dark Mode Por Defecto

**DecisiÃ³n:** Solo dark mode en MVP (#0A0E2A + #3BCDFE).

**Razones:**
- DiseÃ±o del mockup es dark
- Reduce battery drain en OLED
- Preferido por usuarios de productividad

**Post-MVP:** Agregar light mode y auto-switch segÃºn sistema.

---

## ğŸ§ª Validaciones

### AnÃ¡lisis EstÃ¡tico
```bash
$ flutter analyze
Analyzing Clase de Flutter...
No issues found! (ran in 2.2s)
```

### Tests
```bash
$ flutter test
00:03 +1: All tests passed! (1/1)
```

### Cobertura de CÃ³digo
```bash
# Post-MVP (actualmente sin tests exhaustivos)
$ flutter test --coverage
# Objetivo: >70% coverage en Domain y Data layers
```

### DocumentaciÃ³n
- âœ… ARCHITECTURE.md: 1,919 lÃ­neas completas
- âœ… Diagramas C4 con Mermaid
- âœ… Ejemplos de cÃ³digo por componente
- âœ… ADRs documentadas con justificaciones

---

## ğŸ“š Referencias

### Documentos Relacionados

- **[PRD](../task_timer_prd.md):** Requerimientos del producto
- **[MVP TÃ©cnico](../task_timer_mvp_tecnico.md):** Alcance tÃ©cnico
- **[TASK_BREAKDOWN.md](../TASK_BREAKDOWN.md):** Desglose de tareas
- **[IA_RULES.md](../IA_RULES.md):** Reglas para desarrollo con IA

### Especificaciones TÃ©cnicas

- **Clean Architecture:** [blog.cleancoder.com](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- **Riverpod:** [riverpod.dev](https://riverpod.dev/)
- **C4 Model:** [c4model.com](https://c4model.com/)
- **Conventional Commits:** [conventionalcommits.org](https://www.conventionalcommits.org/en/v1.0.0/)

### Commits

- `656b81c` - docs(rules): add professional workflow with feature branches
- `7e79bd9` - docs: Agregar mockup de diseÃ±o al README
- `e95800a` - feat(core): Agregar theme y constants (Tarea 2.1.1)

---

## ğŸ¯ Cumplimiento de Tarea 2.1.7

| Criterio | Estado | Notas |
|----------|--------|-------|
| Documentar capas de Clean Architecture | âœ… | Domain, Data, Presentation completas |
| Crear diagramas de arquitectura | âœ… | Diagramas C4 con Mermaid |
| Documentar flujo de datos | âœ… | Sequence diagrams incluidos |
| Especificar patrones de diseÃ±o | âœ… | Repository, UseCase, Provider |
| Documentar modelo de datos | âœ… | Esquema SQLite completo |
| Incluir decisiones tÃ©cnicas | âœ… | 5 ADRs documentadas |
| Estrategia de testing | âœ… | Unit, Widget, Integration |
| Referencias a PRD y MVP | âœ… | Links en tabla de contenidos |

**ConclusiÃ³n:** Tarea 2.1.7 completada al 100%. El archivo ARCHITECTURE.md estÃ¡ completo, estructurado y listo para servir como referencia tÃ©cnica del proyecto.

---

## â¡ï¸ PrÃ³ximos Pasos

### Siguiente Tarea: 2.2.1

**TÃ­tulo:** Instalar `flutter_riverpod` y configurar `ProviderScope` en `main.dart`

**DescripciÃ³n:**
- Verificar que `flutter_riverpod ^2.5.0` estÃ© en `pubspec.yaml`
- Envolver `MaterialApp` con `ProviderScope`
- Crear archivo `lib/core/providers/providers.dart`
- Documentar configuraciÃ³n de Riverpod

**Dependencias:**
- âœ… 1.1.8: Dependencias instaladas
- âœ… 2.1.6: main.dart creado

**EstimaciÃ³n:** 1-2 horas

---

## ğŸ“‹ Checklist de Completitud

- [x] Archivo ARCHITECTURE.md con 1,919 lÃ­neas
- [x] Diagramas C4 (Context, Container, Component, Sequence)
- [x] DocumentaciÃ³n de las 3 capas principales
- [x] EspecificaciÃ³n de componentes (Screens, Providers, UseCases)
- [x] Modelo de datos SQLite documentado
- [x] Patrones de diseÃ±o identificados
- [x] Decisiones de arquitectura (ADRs) justificadas
- [x] Estrategia de testing definida
- [x] Referencias a PRD, MVP, TASK_BREAKDOWN
- [x] Ejemplos de cÃ³digo por capa
- [x] flutter analyze sin errores
- [x] Tests pasando (1/1)
- [x] Archivo de progreso creado (este documento)
- [x] TASK_BREAKDOWN.md actualizado con âœ…
- [x] Commit con mensaje Conventional Commits
- [x] Push a rama feature/documentar-arquitectura

---

**Generado el:** 2025-11-13 10:45:00 UTC  
**Por:** JuanPMorales  
**Tarea:** TASK_BREAKDOWN.md#2.1.7
